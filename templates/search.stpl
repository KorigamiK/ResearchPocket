<!DOCTYPE html>
<html lang="en">
  <head>
    <% include!("./components/header.stpl"); %>
  </head>
  <body>
    <% include!("./components/item_tags.stpl"); %>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>

    <script>
    /**
    * @typedef item_tag
    * @property {string[]} tags
    * @property {number} id
    * @property {string} uri
    * @property {string} title
    * @property {string} excerpt
    * @property {number} time_added
    * @property {boolean} favorite
    * @property {string} lang
    */

    /**
    * @typedef item_tags
    * @property {0Type} 0
    */

      const options = {
        includeScore: true,
        keys: ['tags', 'excerpt', 'title'],
        logicalOperator: 'or',
        useExtendedSearch: true,
      };

      const fuse = new Fuse(item_tags, options);

      function searchItems(searchQuery) {
        const tags = searchQuery.split(',').map(tag => tag.trim());
        const pattern = tags.map(tag => `'${tag}`).join('|'); 
        const results = fuse.search(pattern);

        return results.map(result => result.item);
      }

    </script>

    <div class="container mx-auto px-4">
      <header class="text-center py-5">
        <h1 class="text-5xl font-bold"><%= title %></h1>
        <p class="my-3">Your personal research library</p>
        <a href="./index.html" class="bg-blue-500 hover:bg-blue-700 font-bold py-2 px-4 rounded">Index</a>
      </header>
      <main>
        <div class="max-w-xl mx-auto">
          <div class="flex mb-4 gap-4">
            <input type="text" id="searchInput" placeholder="Enter tags or excerpt..." class="flex-grow p-2 border rounded-l">
            <button id="searchBtn" class="bg-blue-500 text-white px-4 py-2 rounded-r">Search</button>
          </div>
          <ul id="resultsContainer" class="space-y-4"></ul>
        </div>
      </main>
    </div>

    <script>
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    const resultsContainer = document.getElementById('resultsContainer');

    searchBtn.addEventListener('click', () => {
      const searchQuery = searchInput.value;
      const matchedItems = searchItems(searchQuery); 

      resultsContainer.innerHTML = '';

      matchedItems.forEach(item => {
        const itemElement = document.createElement('li');
        itemElement.style = 'background-color:#eee';
        itemElement.className = 'p-2 rounded flex flex-col gap-2 shadow';

        const tagsHtml = item.tags.map(tag => `<li class="pointer p-2 rounded" style="background-color:#ccf">${tag}</li>`).join('');

        itemElement.innerHTML = `
<h3 class="text-lg font-bold">${item.title}</h3>
<ul class="inline-flex flex-wrap gap-2" >
${tagsHtml}
</ul>
<p class="break-words">${item.excerpt || 'No excerpt available'}</p>
<a href="${item.uri}" target="_blank" class="text-blue-500 hover:underline">Read more</a>
`;
        resultsContainer.appendChild(itemElement);
      });
    });
    </script>
  </body>
</html>
